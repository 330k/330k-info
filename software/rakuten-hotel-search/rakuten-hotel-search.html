<html>
<head>
<meta charset="utf-8">
<title>楽天トラベル 簡易ホテル検索ツール (α)</title>
<meta property="og:title" content="楽天トラベル 簡易ホテル検索ツール (α)" />
<meta property="og:description" content="最終チェックイン時刻と洗濯機の有無の一覧を表示する、楽天トラベルAPIを使った簡易ホテル検索ツールです。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.330k.info/software/rakuten-hotel-search/rakuten-hotel-search.html" />
<meta property="og:image" content="https://www.330k.info/apple-touch-icon.png"/>
<!--<meta name="viewport" content="width=640">-->
<script defer src="https://maps.google.com/maps/api/js?key=AIzaSyA_aFkNjCuqBNETe8bxBk8_cnRQtQzdOG8&amp;callback=initMap"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script>
const googlemap = {
  map: null,
  markers: [],
  lines: [],
  circle: null
};

jQuery(function(){
  $("#hotel_list").resizable({
    handles: 'e'
  });
  
  const resize = function(e){
    $("#map_canvas").width($(document).width() - $("#hotel_list").width() - 15);
  };
  $("#hotel_list").resize(resize);
  $(window).resize(resize);
});

window.addEventListener("DOMContentLoaded", function(){
  /**
   * GPXファイルを読み込むPromiseを返す
   * @param {string} file 読み込むファイル
   * @return {XMLDocument} 読み込んだ結果をXMLObjectを返すPromise
   */
  const readGPX = function(file){
    return new Promise(function(resolve, reject){
      try{
        const reader = new FileReader();
        const parser = new DOMParser();

        reader.onload = function(){
          resolve(parser.parseFromString(reader.result, "text/xml"));
        };
        reader.readAsText(file, "utf-8");
        
      }catch(e){
        reject(e);
      }
    });
  }

  /**
   * GPXデータのルートをGoogle Mapsに表示
   * @param {Object} map
   * @param {XMLDocument} gpx
   * @param {string} color
   * @return {void}
   */
  function showGPXRoute(map, gpx, color){
    const trkpts = gpx.querySelectorAll("trkpt");
    const coords = [];

    for(let i = 1; i < trkpts.length; i++){
      coords.push({
        lat: trkpts[i].getAttribute("lat") - 0,
        lng: trkpts[i].getAttribute("lon") - 0
      });
    }
    
    const line = new google.maps.Polyline({
      path: coords,
      geodesic: true,
      strokeColor: color,
      strokeOpacity: 1.0,
      strokeWeight: 2,
    });

    googlemap.lines.push(line);
    line.setMap(map);
  }

  document.getElementById("gpx_file").addEventListener("change", async function(evt){
    // GPXファイルの読み込み
    try{
      showLoader();

      googlemap.lines.map((e) => {
        e.setMap(null);
      });

      const colors = ["#3f3d99", "#993d71", "#998c3d", "#3d9956", "#3d5a99", "#993d90", "#996d3d", "#43993d"];
      for(let i = 0; i < evt.target.files.length; i++){
        console.log(evt.target.files[i]);
        const gpx = await readGPX(evt.target.files[i]);
        showGPXRoute(googlemap.map, gpx, colors[i % colors.length]);
      }

    }catch(err){
      console.error(err);

    }finally{
      hideLoader();
      
    }
  });

  // ドラッグドロップ対応
  {
    const droparea = document.body;
    const overlay = document.getElementById("overlay");
    droparea.addEventListener("dragover", function(e){
      e.stopPropagation();
      e.preventDefault();
      overlay.style.display = "block";
    }, false);
    overlay.addEventListener("dragleave", function(e){
      e.stopPropagation();
      e.preventDefault();
      overlay.style.display = "none";
    }, false);
    overlay.addEventListener("drop", function(e){
      e.stopPropagation();
      e.preventDefault();
      overlay.style.display = "none";
      
      const files = e.dataTransfer.files;
      document.getElementById("gpx_file").files = files;

      const evt = new Event("change");
      document.getElementById("gpx_file").dispatchEvent(evt);
    }, false)
  };
});

/**
 * Google Maps JavaScript API Initialize Callback
 */
function initMap(){
  googlemap.map = new google.maps.Map(document.getElementById('map_canvas'), {
    zoom: 6,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: new google.maps.LatLng(35.681382, 139.766084),
    fullscreenControl: false
  });
  
  googlemap.map.addListener("click", async function(e){
    const radius = 3;
  
    clearResult();
    showLoader();
    
    googlemap.circle = new google.maps.Circle({
      map: googlemap.map,
      center: new google.maps.LatLng(e.latLng.lat(), e.latLng.lng()),
      radius: radius * 1000,
      strokeColor: '#ff0000',
      fillColor: '#ff0000',
      fillOpacity: 0.3
    });
    
    const searchresult = await getHotelList(e.latLng.lat(), e.latLng.lng(), radius);
    showHotelList(searchresult);
    hideLoader();

  });
  
  googlemap.map.addListener("rightclick", function(e){
    clearResult();
  });
  
  clearResult();
  hideLoader();
}

/**
 * 楽天トラベルAPIでホテルを検索
 * @param {number} latitude 緯度
 * @param {number} longitude 経度
 * @param {number} radius 半径(km)
 * @return {{status:string,hotels:Array}}
 */
async function getHotelList(latitude, longitude, radius){
  const lat = latitude.toFixed(6);
  const lon = longitude.toFixed(6);
  const r = radius.toFixed(1);
  const appid = "1008123474471814322";
  const affid = "219cb501.2d23fbc2.219cb502.49f3944c";

  const result = {
    status: "",
    hotels: []
  };
  
  const url = `https://app.rakuten.co.jp/services/api/Travel/SimpleHotelSearch/20170426?applicationId=${appid}&affiliateId=${affid}&format=json&datumType=1&latitude=${lat}&longitude=${lon}&searchRadius=${r}&responseType=large&allReturnFlag=1`;
  
  try{
    const response = await fetch(url);
    const json = await response.json();
    
    result.status = "SUCCESS";

    if(json.hotels && json.hotels.length > 0){
      json.hotels.map((hotel) => {
        const hotelinfo = {};
        
        hotel.hotel.map((obj) => {
          Object.keys(obj).map((key) => {
            hotelinfo[key] = obj[key];
          });
        });
        
        result.hotels.push(hotelinfo);
      });
      
    }
    if(json.error){
      console.log(json.error);
      result.status = json.error;
    }

  }catch(e){
    console.log(e);
    result.status = "ERROR";
  }

  return result;
}

/**
 * 検索結果を表示
 */
function showHotelList(searchresult){
  googlemap.markers = [];
  const ele_tbody = document.getElementById("tbody_hotel");
  ele_tbody.innerHTML = "";

  const hasCoinLaundry = (hotel) => hotel.hotelFacilitiesInfo.hotelFacilities.some((e) => /コインランドリー/.test(e.item));
  
  // 最終チェックイン時刻が遅い、洗濯機がある順にソート
  const hotels2 = searchresult.hotels.sort((a,b) => {
    const c1 = a.hotelDetailInfo.lastCheckinTime ? a.hotelDetailInfo.lastCheckinTime : "";
    const c2 = b.hotelDetailInfo.lastCheckinTime ? b.hotelDetailInfo.lastCheckinTime : "";
    
    if(c1 > c2){
      return -1;
    }else if(c1 < c2){
      return 1;
    }else{
      const h1 = hasCoinLaundry(a) ? 1 : 0;
      const h2 = hasCoinLaundry(b) ? 1 : 0;

      return h2 - h1;
    }
  });
  console.log(hotels2);

  for(i = 0; i < hotels2.length; i++){
    const hotel = hotels2[i];
    const hotel_no = hotel.hotelBasicInfo.hotelNo;
    const hotel_row_id = "hotel_" + hotel_no;
    const ele_tr = document.createElement("tr");
    
    ele_tr.id = hotel_row_id;
    ele_tr.innerHTML = "<td>" + (i + 1) + "</td>"
      + "<td><a href='" + hotel.hotelBasicInfo.hotelInformationUrl + "' target='_blank'>" + hotel.hotelBasicInfo.hotelName + "</a></td>"
      + "<td>" + hotel.hotelDetailInfo.checkinTime + "-" + (hotel.hotelDetailInfo.lastCheckinTime ? hotel.hotelDetailInfo.lastCheckinTime : "") + "</td>"
      + "<td>" + (hasCoinLaundry(hotel) ? "✓" : "") + "</td>"
    
    const infowindow = new google.maps.InfoWindow({
      content: "<a href='" + hotel.hotelBasicInfo.hotelInformationUrl + "' target='_blank'>" + hotel.hotelBasicInfo.hotelName + "</a>"
        + "<br><br>チェックイン時間: " + hotel.hotelDetailInfo.checkinTime + "-" + (hotel.hotelDetailInfo.lastCheckinTime ? hotel.hotelDetailInfo.lastCheckinTime : "")
        + "<br>洗濯機: " + (hasCoinLaundry(hotel) ? "あり" : "なし")
        + "<br>最安値: " + (hotel.hotelBasicInfo.hotelMinCharge ? (hotel.hotelBasicInfo.hotelMinCharge + "円") : "情報なし")
        
        + "<br><br><img src='" + hotel.hotelBasicInfo.hotelThumbnailUrl + "'/>"
        + (hotel.hotelBasicInfo.roomThumbnailUrl ? "<img src='" + hotel.hotelBasicInfo.roomThumbnailUrl + "'/>" : "")
    });
    const marker = new google.maps.Marker({
      position: {lat: hotel.hotelBasicInfo.latitude, lng: hotel.hotelBasicInfo.longitude},
      title: hotel.hotelBasicInfo.hotelName,
      label: `${i + 1}`,
      map: googlemap.map
    });
    marker.addListener("click", () => {
      infowindow.open({
        anchor: marker,
        map: googlemap.map,
        shouldFocus: false
      });
    });
    marker.addListener("mouseover", () => {
      ele_tr.classList.add("hotel_selected");
    });
    marker.addListener("mouseout", () => {
      ele_tr.classList.remove("hotel_selected");
    });
    
    ele_tr.addEventListener("mouseover", () => {
      ele_tr.classList.add("hotel_selected");
      infowindow.open({
        anchor: marker,
        map: googlemap.map,
        shouldFocus: false,
      });
    });
    ele_tr.addEventListener("mouseout", () => {
      ele_tr.classList.remove("hotel_selected");
      infowindow.close();
    });
    
    ele_tbody.appendChild(ele_tr);
    googlemap.markers.push(marker);
  }

  if(searchresult.status === "SUCCESS"){
    document.getElementById("message").innerHTML = "検索結果: " + searchresult.hotels.length + "件</p>";
  }else if(searchresult.status === "not_found"){
    document.getElementById("message").innerHTML = "見つかりませんでした";
  }else if(searchresult.status === "ERROR"){
    document.getElementById("message").innerHTML = "API呼び出しエラー";
  }else{
    document.getElementById("message").innerHTML = "";
  }
}

/**
 * 結果を初期化
 */
function clearResult(){
  if(googlemap.circle){
    googlemap.circle.setMap(null);
  }
  googlemap.circle = null;

  googlemap.markers.map((e) => {
    e.setMap(null);
  });
  googlemap.markers = null;
  
  showHotelList({
    status: "",
    hotels: []
  });
}

function hideLoader(){
  document.getElementById("loader_bg").style.display = "none";
}

function showLoader(){
  document.getElementById("loader_bg").style.display = "block";
}
</script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-5655726-3', 'auto');
  
  ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
<style>
* { margin: 0; padding: 0}
#wrapper {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#map_canvas {
  position: absolute;
  top: 0;
  right: 0;
  width: 75%;
  height: 100%;
}
#hotel_list {
  position: absolute;
  top: 0;
  left: 0;
  width: 25%;
  height: 100%;
  overflow-x: hidden;
  overflow-y: scroll;
  background-color: #fff;
}
#hotel_list table {
  border-collapse: collapse;
  width: 100%;
}
#hotel_list table thead {
  background-color: #eee;
}
#hotel_list table tbody {
  
}
#hotel_list table td {
  border-width: 1px 0;
  border-color: gray;
  border-style: solid;
  text-align: center;
}

#loader_bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(1, 1, 1, 0.25);
  z-index: 9999;
}
#loader {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 10px;
  border-radius: 30px;
  background: #ddd;
}

.hotel_selected {
  background: #ccc;
}

#gpx_file { 
  display: none;
}

#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  background-color: #ddd;
  opacity: 0.5;
  display: none;
}

.dropover {
  background-color: rgba(240, 240, 240, 0.5);
  display: block;
}
</style>
</head>
<body>
<div id="wrapper">
<div id="hotel_list">
<table id="table_hotels">
<thead>
<tr><th style="width: 2em;">No</th><th>ホテル名</th><th style="width: 11em;">チェックイン</th><th style="width: 4em;">洗濯機</th></tr>
</thead>
<tbody id="tbody_hotel">
</tbody>
</table>
<div id="message"></div>
</div>
<div id="map_canvas"></div>
</div>
</div>
<div id="loader_bg">
<div id="loader">
<img src="data:image/svg+xml,%3Csvg width='32' height='32' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid' class='uil-spin'%3E%3Cpath fill='none' class='bk' d='M0 0h100v100H0z'/%3E%3Cg transform='translate(84 50)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(45 -52.355 126.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.12s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.12s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(90 -17 67)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.25s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.25s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(135 -2.355 42.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.37s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.37s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(180 8 25)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.5s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.5s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-135 18.355 7.603)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.62s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.62s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-90 33 -17)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.75s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.75s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-45 68.355 -76.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.87s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.87s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3C/svg%3E" width="128" height="128">
</div>
</div>
<input type="file" id="gpx_file" accept=".gpx" />
<div id="overlay"></div>
</body>
</html>
